import { connectDB } from '@/api/utils/db'
import email from '@/lib/actions/email'
import { ADMIN_EMAIL, APP_URL } from '@/data/constants'
import type { UserProps } from '@/types'
import { ResultSetHeader } from 'mysql2/promise'

export async function PUT(req: Request) {
  const body = await req.json()
  const { userId } = body

  if (!userId) throw new Error('Token ID is required')

  try {
    // Check if user exists
    const user = (
      (await connectDB(`SELECT * FROM users WHERE shms_id = ?`, [userId])) as UserProps[]
    )[0]

    // If user does not exist
    if (!user) {
      return new Response(
        JSON.stringify({ userAdded: 0, message: 'Ø¹ÙÙˆØ§Ù‹ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø³Ø§Ø¨!' }),
        { status: 404 }
      )
    }

    // If user exists but already activated
    if (user && new Date() >= new Date(user.shms_user_reset_token_expires!)) {
      return new Response(
        JSON.stringify({ userAdded: 0, message: 'Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø±Ø§Ø¨Ø· ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨!' }),
        { status: 400 }
      )
    } else if (
      user.shms_user_reset_token_expires === null &&
      (user.shms_user_account_status === 'active' ||
        user.shms_user_account_status === 'block')
    ) {
      return new Response(
        JSON.stringify({ userAdded: 0, message: 'Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙØ¹Ù„ Ø³Ø§Ø¨Ù‚Ø§Ù‹' }),
        { status: 400 }
      )
    } else {
      // activate user
      const activateUser = (await connectDB(
        `UPDATE users
          SET shms_user_account_status = ?, 
            shms_user_reset_token_expires = NULL
            WHERE shms_id = ?`,
        ['active', userId]
      )) as ResultSetHeader

      const { affectedRows: isActivated } = activateUser as ResultSetHeader

      if (isActivated) {
        //send the user an email with a link to activate his/her account
        const buttonLink = APP_URL + `/auth/signin`

        const emailData = {
          from: `Ø´Ù…Ø³ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ© | SHMS Agriculture <${ADMIN_EMAIL}>`,
          to: user?.shms_email,
          subject: 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ | Ø´Ù…Ø³ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ©',
          msg: {
            title: 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø´Ù…Ø³ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ©',
            msg: `
            <h1 style="font-weight:bold">Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user?.shms_fullname},</h1>
            <p>
             Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ³Ø¬ÙŠÙ„Ùƒ ÙÙŠ Ø´Ù…Ø³ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØŒ
             ØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¯Ù†Ø§Ù‡:
            </p>
            <br /><br />
            <small>Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ¹ØªÙ‚Ø¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØµÙ„Ùƒ Ø¨Ø§Ù„Ø®Ø·Ø£ØŒ Ø£Ùˆ Ø£Ù† Ù‡Ù†Ø§Ù„Ùƒ Ù…Ø´ÙƒÙ„Ø© Ù…Ø§ØŒ ÙŠØ±Ø¬Ù‰ ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ù† ÙØ¶Ù„Ùƒ!</small>`,
            buttonLink,
            buttonLabel: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'
          }
        }

        const data = await email(emailData)
        if (data?.id) {
          return new Response(
            JSON.stringify({
              userActivated: 1,
              message: `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„ØªØ£ÙƒÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‘ğŸ¼`
            }),
            { status: 201 }
          )
        } else {
          return new Response(
            JSON.stringify({
              userActivated: 0,
              message: `Ø¹ÙÙˆØ§Ù‹ØŒ Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„ØªØ£ÙƒÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…!`
            }),
            { status: 500 }
          )
        }
      }
    }
  } catch (err) {
    console.error(err)
    return new Response(
      JSON.stringify({
        userActivated: 0,
        message: `Ø¹ÙÙˆØ§Ù‹ØŒ Ù„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!`
      }),
      { status: 500 }
    )
  }
}
